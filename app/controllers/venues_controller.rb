require 'open-uri'
require 'json'
	
class VenuesController < ApplicationController

	@@DATE = "20130221"; #YYYYMMDD
	@@BASE_URL = "https://api.foursquare.com/v2/venues/search?v=" + @@DATE + "&ll="
	@@MAX_NUMBER = "50"

	@@client_id = ["UCG0COIKMJULODNLYE5QOGN3RDFZRUQGYM5XYQKD02VSBZ51", "3KZP5PXKV1VMHV3VWESXDWVDIYV4ZCOE3OLW3PMCE4CO0IQZ", "EB1P4VX4EX3LLF1QBPBK1IZNBI0LJWY3SLHHAL1R0D0JF5NO", "2YE1CGYS4HIH51QDTPV1F2D1F4LZT5EF0P02U504KIGHFQKA", "CCEXSHGCMYICMHDPLLBAJSMHMUFAQFX1WHL4EEP44AFOSHLK", "ZFHDBUCOHBPO4FDM4QZZZF124215R5FEBE3BMIWPVJY2AQX3", "JNTSGFDTMFNVL5FOSG3POUDAK3BSRCST2B3YQVATKDGGA3PI", "GSM51X0WOIIFZS5R4A3KVGNPQLIO4UJFRGIMZB0JFTGAQW1M", "BBCWFZKBEZGSSTZ2XYM3YGM2ZMTLDP0UHV2JC3415X03TFST", "SAS52EFPAJ2FJ40ENYJ3TG3TTUBLWYPX2FSUJFULOQPGQM52", "3VV5NW5XEFX1JIWXFM14C4PC1HYFFEIYNVJSK50KVNIHQDUB", "SYSG45TJ5SRKXM3ZLATRUTJCM3RZX5TFTE3DYWBVQ4002SKD", "2S2K01SZ2JTMNW3TORBWLKKL5IMG5XPIBGAWYSKTYCCYTCHV", "VGOGHRJBEF0EX2GJPHTUK1ASPCZ21W2X3AR421D0YLVFDIQA", "ORYRNM5XF43P2SRKZPO3AFYGWNIAHCDBWX44VDGFYFIKHMO1", "VFLIH5BO0S13GCHTT55ERHE4T3EQ4IUPBDQ4QS4MANMILIYD", "QKOLYXDUK5C32YSPWEQ3AGTLJWF34YQ2UIRGGRNVZAA0VXK3", "3WJVLBAPH2041TE5ATWTRQRBAYZ4XHJVNVJS14P5WX2FCCUB", "GMZOSXLRVQYFUDBFAXB0UEKKGWFKM4KBNRLYNV555KPAB1L0", "RHUISE32CK0JP04FKZKG214T535S3Z0NMR2VTVEYAPG4WVTM", "NLFG2OLON1RVRANVHTCMNQY13ZHWTGLXMBSMDK4NKGXCYUNP", "QCEHVTQVFOY1FE43IQL0REX5MP3LRUCFVL5CQUVZAOGLTFYC", "DQNAI40MIXPP0WWLX20QJT3325UXE5THFC4GWS4IS1ZYRHHT", "4TUC4HDHURLU2UWU30XMWLTL40THPFY12UW3NHVYEGTV3RMS", "OLNYZCEOXCVVHQFSICFUPRLUFBUVDCUDWLBLJ5LWDLF0FMTK", "2DYFVGGFSEZR5ZTJEJBNRBMWLGGD3HPVWPJFXYN2PAJCNILC", "J3OHXECOPI5JVO41A2X4IAAOACNZMPVZJUSVCJTKEWIP4AWO", "CSUR1VI1Q0CUIX0N15FLUYPH50KYCM5C21LAKADAJXWKJHNT", "RQDILAGJVLG5VQVVPBKAEVPZ5DDVXCZMYUAVNM2DBZ0YIJOD", "HZVH2LQOVKVFM355S40UCAA4WDQUCCW5LYGTWOXUAPK3Z50K"]

	@@client_secret = ["S2ZMRZNF4LO22QESS4S4HZ2C3XHSZ5EDY0N1IIZ5BPB0DYSB", "OXWAW2DM2HXTT21AMXCK2OD5REQ10DEWX530G23W3NQ5XLNO", "GOSWMBILBT2QJUX4KOAHIDNVJ5OPQHO3GEP3J0GVKIFCQG5E", "SJRETBHAGHX4MYNAEY1BDQLI2USHDVQ33WN1435GF4KJYAAZ", "YN3AXIMYJS2SY5T0JZBUJLRGHZUGE1GZXKNCDSE2E4TZAGPZ", "V40HJN4FKWUIBKO2LU4LCFETYEFHTZOARZTLXHJIZDYMTGKA", "KHPHMHXC3WGQLKJHWSM41EP3R1UKB4AQ1F101SNPGGQWDTZW", "DHTFUWREFBDQM13QYJ1V5DCGJCZEBS0OB2EKBIXPNIHP2IBW", "SFPONLI3UXHJOLWBZGDLM2XFI5TLD3WPP4EVVGCGOBE4LUVF", "TH4CYD0RZXS2FJ3BQJAPLDCYGFUR5SS3AMVNZDE0TPRXEPAE", "V5KTOIZ3YNSJST4POSWHM5IOMIJ5WL0L1KR0BSNC5HC3VBWY", "CKSB3PDZW2VR5R2OPFMF0JL21LHTCD1BV4RAWSWR5LN15CFK", "EJAFJYNUF44EGY5RZ5OPUCLLC01UTZJYRKOSYZCMGVEAUDR4", "KQY1XY5MAW4CCUWBSEDUBMNPNXZUWY5EVRSMHEFT5XEDIXBK", "UH0UGCOLHGYPEEF15OUNLDUBNQOEUHT5QYRGCAHWH2YZB5IP", "LWCBNDVNQT4QNSUZSLLR5WXOZRDA4LGLBHJFJT2ZUGION2LC", "YJCGIAABY34ZQRG1RM0ZO2HHKGBI4DPFNCFLZIBEWL5BEFP2", "51VRFTGVWMSJV1QRZBTIHFBG45HLG5MXSAF1K042N01LLYRX", "FVLR1SBV4Z23XJ34AKMFP1IIYKLSPA5J2UYZGT5TDU4XQF3U", "1ZINYNHHV31ELQZHORG0LF3HFQRA1DD222YCCGGCQXUZTLUD", "NWK025URGFWBH3QM5EBT4XWNTCVSSKZH5LXOLHLUHZOL2CM0", "OUADQ4HDZIFI2MYA2N1PQJW5JAHIT0HMHQ4NKLBIE2VD0PCQ", "4TUC4HDHURLU2UWU30XMWLTL40THPFY12UW3NHVYEGTV3RMS", "0ZIJCUARDBNEV02D0SILE4TOXXAENYNVLXTUG4HMWUGDK0AA", "AURRV2KJTWE1QIXSDRIO3ZB20GKIX25TTV2CTB0H4PT4XCP0", "3P0JDVBG1OS30UZONJ20GDSE54QUVAE31VA1HUTR1RN4ATLU", "RSQREXYPOM3C2GWCADNOKOZXW2SUCTHQSBI5SXTN4P5YVPPT", "33W5PN2JPOLXHWAPUPTV5DWPYCQDSJ552HBGWMRNAWMVG1BP", "BCD0JYL3OHGQJCAG2JDSCUG3IP1MGR2MXTT5IRDDCGHQ3D5K", "KNGSK0ZB1TW5VLKF0XH1QJTEVD4WYAY5LVHVFYJMIRM0F3RV"]

  def index
    respond_to do |format|
      format.html # index.html.erb
      format.json { render json: Venue.find(:all, :conditions => ['herenow > ?', 0])  }
    end
    
  end
  
  
  def update_data 

	# loop through all points 
	Point.all.each do |point| 
	
		@@request = @@BASE_URL + Point.all.first.lat.to_s + "," + Point.all.first.lng.to_s + "&limit=" + @@MAX_NUMBER + "&client_id=" + @@client_id[point.id%20] + "&client_secret=" + @@client_secret[point.id%20]

		logger.info(@@request) 

		@parsed = JSON.parse(open(@@request).read)
		
		@result = @parsed["response"]["venues"]

		@result.each do |venue| 
		
			@@id = venue["id"] 
			@@lat = venue["location"]["lat"].to_s
			@@lng = venue["location"]["lng"].to_s
			@@name = venue["name"]
			@@herenow = venue["hereNow"]["count"]
			
			if venue["categories"]
				categoryLink = venue["categories"]
				logger.info(categoryLink)
				# .first["icon"]["prefix"].split("/")
				@@category = "test" 
			end
			
			# if the venue already exists in the database 
			if Venue.find_by_foursqr_id(@@id) 
				@@v = Venue.find_by_foursqr_id(@@id)
				if @@v.herenow == @@herenow  
					# do nothing 
				else 
					# update venue
					@@v.update_attributes(:herenow => @@herenow.to_i)
				end 
			else 
				Venue.create(
					:foursqr_id => @@id,  
					:name => @@name, 
					:lat => @@lat,
					:lng => @@lng,
					:herenow => @@herenow, 
					:category => @@category
					)
			end 
			
			
		end 

	end 


    respond_to do |format|
      format.html {render :template => 'venues/update.html.erb'} 
    end
    
  end 
  
  

end
